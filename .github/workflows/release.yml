name: Build Release Artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0, 1.2.3-beta.1)"
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-version:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format '${{ inputs.version }}'. Expected semver (e.g. 1.0.0 or 1.2.3-beta.1)"
            exit 1
          fi

  test:
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - uses: oven-sh/setup-bun@v2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: bun install

      - name: TypeScript check
        run: bun run typecheck

      - name: Frontend tests
        run: bun run test --run

      - name: Build docs site
        run: cd docs-site && bun install && bun run build

      - name: Rust tests
        run: cargo test --manifest-path src-tauri/Cargo.toml

  build:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            artifact_suffix: linux-amd64
            tauri_bundles: deb,appimage
          - platform: ubuntu-24.04
            rust_target: x86_64-unknown-linux-gnu
            artifact_suffix: linux-rpm
            tauri_bundles: rpm
          - platform: windows-latest
            rust_target: x86_64-pc-windows-msvc
            artifact_suffix: windows-x64
            tauri_bundles: nsis,msi
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux system dependencies
        if: startsWith(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf rpm

      - uses: oven-sh/setup-bun@v2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.rust_target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: ${{ matrix.platform }}-${{ matrix.tauri_bundles }}

      - name: Bump versions for build
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          # MSI/WiX only supports numeric pre-release identifiers — strip the
          # pre-release suffix for tauri.conf.json (e.g. 1.0.0-beta.1 → 1.0.0)
          MSI_VERSION="${VERSION%%-*}"

          # package.json — full semver
          bun -e "
            const pkg = JSON.parse(await Bun.file('package.json').text());
            pkg.version = '${VERSION}';
            await Bun.write('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # src-tauri/tauri.conf.json — MSI-safe version
          bun -e "
            const conf = JSON.parse(await Bun.file('src-tauri/tauri.conf.json').text());
            conf.version = '${MSI_VERSION}';
            await Bun.write('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2) + '\n');
          "

          # src-tauri/Cargo.toml — full semver
          sed -i "0,/^version = .*/s//version = \"${VERSION}\"/" src-tauri/Cargo.toml

          # Regenerate Cargo.lock
          cargo generate-lockfile --manifest-path src-tauri/Cargo.toml

      - name: Install frontend dependencies
        run: bun install

      - name: Build docs site
        run: cd docs-site && bun install && bun run build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: bun run tauri
          args: --bundles ${{ matrix.tauri_bundles }}

      - name: Rename artifacts with platform suffix
        shell: bash
        run: |
          SUFFIX="${{ matrix.artifact_suffix }}"

          rename_glob() {
            local ext="$1"
            for f in $2; do
              [ -f "$f" ] && mv "$f" "${f%.$ext}_${SUFFIX}.$ext"
            done
            return 0
          }

          rename_glob deb       "src-tauri/target/release/bundle/deb/*.deb"
          rename_glob AppImage  "src-tauri/target/release/bundle/appimage/*.AppImage"
          rename_glob rpm       "src-tauri/target/release/bundle/rpm/*.rpm"
          rename_glob exe       "src-tauri/target/release/bundle/nsis/*.exe"
          rename_glob msi       "src-tauri/target/release/bundle/msi/*.msi"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.artifact_suffix }}
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi
          if-no-files-found: ignore

  finalize-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Bump versions
        run: |
          VERSION="${{ inputs.version }}"
          MSI_VERSION="${VERSION%%-*}"

          # package.json — full semver
          bun -e "
            const pkg = JSON.parse(await Bun.file('package.json').text());
            pkg.version = '${VERSION}';
            await Bun.write('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # src-tauri/tauri.conf.json — MSI-safe version (no pre-release suffix)
          bun -e "
            const conf = JSON.parse(await Bun.file('src-tauri/tauri.conf.json').text());
            conf.version = '${MSI_VERSION}';
            await Bun.write('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2) + '\n');
          "

          # src-tauri/Cargo.toml — full semver
          sed -i "0,/^version = .*/s//version = \"${VERSION}\"/" src-tauri/Cargo.toml

          # docs-site roadmap.mdx — update version badge
          sed -i 's/<Badge text="Version [^"]*"/<Badge text="Version '"${VERSION}"'"/' docs-site/src/content/docs/developer/roadmap.mdx

          # Regenerate Cargo.lock
          cargo generate-lockfile --manifest-path src-tauri/Cargo.toml

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml src-tauri/Cargo.lock docs-site/src/content/docs/developer/roadmap.mdx
          git commit -m "release: v${{ inputs.version }}"
          git tag "v${{ inputs.version }}"
          git push origin HEAD --tags

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: List artifacts
        run: find release-artifacts -type f | sort

      - name: Re-upload as single artifact
        uses: actions/upload-artifact@v4
        with:
          name: diagrammer-v${{ inputs.version }}
          path: |
            release-artifacts/**/*.deb
            release-artifacts/**/*.AppImage
            release-artifacts/**/*.rpm
            release-artifacts/**/*.exe
            release-artifacts/**/*.msi
          if-no-files-found: warn
          retention-days: 90
